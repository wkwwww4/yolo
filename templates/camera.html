<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å¯¦æ™‚æ”åƒé ­æª¢æ¸¬ - yolo_backend</title>
    <style>
      body { font-family: Arial, Helvetica, sans-serif; margin: 24px; }
      .box { max-width: 960px; margin: auto; }
      #video { border: 2px solid #333; width: 100%; max-width: 640px; margin: 10px 0; }
      #canvas { display: none; }
      #result { border: 2px solid #0c0; width: 100%; max-width: 640px; margin: 10px 0; }
      button { padding: 8px 16px; margin: 5px; font-size: 14px; cursor: pointer; }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      .status { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px; }
      .info { color: #666; font-size: 12px; }
      a { color: #0066cc; }
    </style>
  </head>
  <body>
    <div class="box">
      <h1>å¯¦æ™‚æ”åƒé ­æª¢æ¸¬ï¼ˆYOLO äººæµè¨ˆæ•¸ï¼‰</h1>
      <p><a href="/">â† å›åˆ°ä¸Šå‚³é é¢</a></p>

      <div class="status">
        <p>ç‹€æ…‹ï¼š<span id="status">å°±ç·’</span></p>
        <p class="info">
          é¦–æ¬¡ä½¿ç”¨éœ€è¦å…è¨±ç¶²ç«™å­˜å–æ”åƒé ­ã€‚FPS æ ¹æ“šæª¢æ¸¬é€Ÿåº¦è‡ªå‹•èª¿æ•´ï¼ˆç´„ 1-2 ç§’ä¸€å¹€ï¼‰ã€‚
        </p>
      </div>

      <h3>æ”åƒé ­ä¸²æµ</h3>
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>

      <div>
        <button id="startBtn" type="button">é–‹å§‹æª¢æ¸¬</button>
        <button id="stopBtn" type="button" disabled>åœæ­¢æª¢æ¸¬</button>
        <button id="captureBtn" type="button">æ‹ç…§ (ç™¼é€æª¢æ¸¬)</button>
      </div>

      <h3>æª¢æ¸¬çµæœ</h3>
      <img id="result" src="" alt="æª¢æ¸¬çµæœ" style="display: none; border: 2px solid #0c0; width: 100%; max-width: 640px; margin: 10px 0;">
      <div style="border: 1px solid #ccc; padding: 10px; border-radius: 4px; margin: 10px 0;">
        <p class="info">äººæ•¸ï¼š<strong id="detection-people">-</strong> | æ™‚é–“ï¼š<strong id="detection-time">-</strong>ms</p>
        <button id="downloadBtn" type="button" disabled style="background-color: #0066cc; color: white; padding: 8px 16px; margin: 5px; cursor: pointer;">â¬‡ ä¸‹è¼‰æª¢æ¸¬çµæœ</button>
        <button id="downloadCsvBtn" type="button" disabled style="background-color: #009900; color: white; padding: 8px 16px; margin: 5px; cursor: pointer;">ğŸ“Š ä¸‹è¼‰çµ±è¨ˆ CSV</button>
      </div>
    </div>

    <script>
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const result = document.getElementById('result');
      const statusElem = document.getElementById('status');
      const detectionInfoElem = document.getElementById('detection-info');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const captureBtn = document.getElementById('captureBtn');

      let stream = null;
      let isRunning = false;
      let frameCount = 0;
      let lastResultBase64 = null;
      let detectionStats = [];

      startBtn.addEventListener('click', async () => {
        try {
          statusElem.textContent = 'è¦æ±‚æ”åƒé ­æ¬Šé™...';
          stream = await navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 640 }, height: { ideal: 480 } }
          });
          video.srcObject = stream;
          statusElem.textContent = 'æ”åƒé ­å·²é€£æ¥ï¼ŒæŒ‰ã€Œé–‹å§‹æª¢æ¸¬ã€';
          startBtn.disabled = true;
          stopBtn.disabled = false;
          captureBtn.disabled = false;
          startDetection();
        } catch (err) {
          statusElem.textContent = `éŒ¯èª¤: ${err.message}`;
        }
      });

      stopBtn.addEventListener('click', () => {
        isRunning = false;
        statusElem.textContent = 'å·²åœæ­¢';
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }
        startBtn.disabled = false;
        stopBtn.disabled = true;
        captureBtn.disabled = true;
      });

      captureBtn.addEventListener('click', () => {
        if (stream && video.videoWidth > 0) {
          sendFrame();
        }
      });

      document.getElementById('downloadBtn').addEventListener('click', () => {
        if (lastResultBase64) {
          const link = document.createElement('a');
          link.href = 'data:image/jpeg;base64,' + lastResultBase64;
          link.download = `detection_${new Date().toISOString().replace(/[:.]/g, '-')}.jpg`;
          link.click();
        }
      });

      document.getElementById('downloadCsvBtn').addEventListener('click', () => {
        if (detectionStats.length === 0) {
          alert('å°šç„¡çµ±è¨ˆæ•¸æ“š');
          return;
        }
        let csv = 'Timestamp,PeopleCount,InferenceTime\n';
        detectionStats.forEach(stat => {
          csv += `${stat.timestamp},${stat.people},${stat.time.toFixed(2)}\n`;
        });
        const link = document.createElement('a');
        link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        link.download = `detection_stats_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;
        link.click();
      });

      function startDetection() {
        isRunning = true;
        statusElem.textContent = 'æª¢æ¸¬ä¸­...';
        frameCount = 0;
        detectLoop();
      }

      function detectLoop() {
        if (!isRunning || !stream) return;

        frameCount++;
        if (frameCount % 15 === 0) { // æ¯ 15 å¹€ç™¼é€ä¸€æ¬¡ï¼ˆæ ¹æ“šå¹€ç‡è‡ªå‹•èª¿æ•´ï¼‰
          sendFrame();
        }

        requestAnimationFrame(detectLoop);
      }

      function sendFrame() {
        if (!video.videoWidth || !video.videoHeight) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        canvas.toBlob(blob => {
          const formData = new FormData();
          formData.append('image', blob, 'frame.jpg');

          statusElem.textContent = 'æª¢æ¸¬ä¸­...';
          fetch('/api/detect', {
            method: 'POST',
            body: formData
          })
          .then(res => res.json())
          .then(data => {
            if (data.image) {
              result.src = 'data:image/jpeg;base64,' + data.image;
              result.style.display = 'block';
              lastResultBase64 = data.image;
              document.getElementById('downloadBtn').disabled = false;
              document.getElementById('downloadCsvBtn').disabled = false;
              
              document.getElementById('detection-people').textContent = data.people_count;
              document.getElementById('detection-time').textContent = data.inference_time.toFixed(1);
              
              detectionStats.push({
                timestamp: new Date().toISOString(),
                people: data.people_count,
                time: data.inference_time
              });
              
              statusElem.textContent = `âœ“ æª¢æ¸¬å®Œæˆ (äººæ•¸: ${data.people_count})`;
            }
          })
          .catch(err => {
            statusElem.textContent = `æª¢æ¸¬éŒ¯èª¤: ${err}`;
            console.error(err);
          });
        }, 'image/jpeg', 0.85);
      }
    </script>
  </body>
</html>
